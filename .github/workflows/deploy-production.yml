name: Deploy production build

on:
  workflow_dispatch

env:
  CARGO_TERM_COLOR: always
  CLICOLOR: 1

jobs:

  do-production-build:
    permissions:
      actions: write
      contents: write
      deployments: write
      id-token: write
      issues: none
      packages: write
      pages: none
      pull-requests: none
      repository-projects: none
      security-events: read
      statuses: write

    name: Deploy test build to production
    strategy:
      fail-fast: false
    runs-on: self-hosted
    steps:
      - name: Set up Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
      - name: Switch to production branch
        uses: actions/checkout@v4
        with:
          ref: production-build
      - name: Fast-forward production build
        run: |
          if ! git pull --ff-only origin test-build; then
            echo "Could not fast-forward; merging..."
            # git reset --hard origin/test-build
            git merge --no-ff
          fi
          git status
      - name: Push changes into production build
        run: |
          git push
